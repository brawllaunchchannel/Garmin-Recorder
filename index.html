<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garmin Video Recorder Pro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .video-container {
            position: relative;
            flex: 1;
            background: black;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #videoPreview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .no-video {
            color: #666;
            font-size: 1.2rem;
            text-align: center;
        }

        .recording-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
            display: none;
            animation: pulse 1s infinite;
        }

        .speech-feedback {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #4CAF50;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            display: none;
            max-width: 90%;
            text-align: center;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }

        .status-panel {
            background: rgba(0,0,0,0.4);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .status-text {
            font-size: 1.5rem;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .status-listening { color: #4CAF50; }
        .status-recording { color: #f44336; }
        .status-inactive { color: #999; }

        .recognition-quality {
            font-size: 0.9rem;
            color: #ccc;
            margin-top: 10px;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #666;
            color: white;
        }

        .btn-secondary:hover {
            background: #555;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #FF9800;
            color: white;
        }

        .btn-warning:hover {
            background: #F57C00;
            transform: translateY(-2px);
        }

        .commands-info {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .commands-info h3 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .command-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .command-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
        }

        .command-item strong {
            color: #4CAF50;
            display: block;
            margin-bottom: 8px;
        }

        .command-variants {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .listening-animation {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #4CAF50;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .download-section {
            margin-top: 20px;
            text-align: center;
        }

        .video-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .video-item {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-direction: column;
        }

        .audio-test {
            background: rgba(255, 165, 0, 0.2);
            border: 2px solid #FF9800;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .command-grid { grid-template-columns: 1fr; }
            .controls { flex-direction: column; align-items: center; }
            .btn { width: 100%; max-width: 300px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé• Garmin Video Recorder Pro</h1>
        <p>Intelligente Sprachsteuerung</p>
    </div>

    <div class="video-container">
        <video id="videoPreview" autoplay muted playsinline style="display: none;"></video>
        <div class="no-video" id="noVideoText">üìπ Kamera wird geladen...</div>
        <div class="recording-indicator" id="recordingIndicator">üî¥ AUFNAHME L√ÑUFT</div>
        <div class="speech-feedback" id="speechFeedback">Erkannt: "..."</div>
    </div>

    <div class="status-panel">
        <div class="status-text" id="statusText">Initialisierung...</div>
        <div id="listeningIndicator" style="display: none;">
            <span class="listening-animation"></span>
            H√∂re auf Sprachbefehle...
        </div>
        <div class="recognition-quality" id="recognitionQuality"></div>
    </div>

    <div class="controls">
        <button class="btn btn-primary" id="startListeningBtn">üé§ Spracherkennung starten</button>
        <button class="btn btn-danger" id="manualRecordBtn">üé¨ Manuell aufnehmen</button>
        <button class="btn btn-secondary" id="stopRecordBtn" style="display: none;">‚èπÔ∏è Aufnahme stoppen</button>
        <button class="btn btn-warning" id="testAudioBtn">üîä Audio testen</button>
    </div>

    <div class="audio-test" id="audioTest" style="display: none;">
        <h4>üéß Audio-Status</h4>
        <div id="audioStatus">Teste Audio-Aufnahme...</div>
    </div>

    <div class="download-section" id="downloadSection" style="display: none;">
        <h3>üì• Aufgenommene Videos</h3>
        <div class="video-list" id="videoList"></div>
    </div>

    <div class="commands-info">
        <h3>üó£Ô∏è Erweiterte Sprachbefehle</h3>
        <div class="command-grid">
            <div class="command-item">
                <strong>Video starten:</strong>
                <div class="command-variants">
                    ‚Ä¢ "OK Garmin Aufnahme starten"<br>
                    ‚Ä¢ "Okay Garmin Video starten"<br>
                    ‚Ä¢ "Garmin starte Aufnahme"<br>
                    ‚Ä¢ "Start Video Garmin"
                </div>
            </div>
            <div class="command-item">
                <strong>Video stoppen:</strong>
                <div class="command-variants">
                    ‚Ä¢ "OK Garmin Video speichern"<br>
                    ‚Ä¢ "Okay Garmin Aufnahme speichern"<br>
                    ‚Ä¢ "Garmin stoppe Video"<br>
                    ‚Ä¢ "Stop Aufnahme Garmin"
                </div>
            </div>
        </div>
        <p style="margin-top: 15px; font-size: 0.9rem; color: #ccc;">
            üí° Tipp: Sprechen Sie klar und deutlich. Bei Problemen nutzen Sie die manuellen Buttons.
        </p>
    </div>

    <script>
        class VoiceVideoRecorderPro {
            constructor() {
                this.mediaRecorder = null;
                this.recordedChunks = [];
                this.isRecording = false;
                this.isListening = false;
                this.recognition = null;
                this.stream = null;
                this.recordedVideos = [];
                this.recognitionAttempts = 0;
                this.recognitionSuccess = 0;

                // Erweiterte Sprachbefehle - mehr Variationen
                this.startCommands = [
                    'ok garmin aufnahme starten',
                    'okay garmin aufnahme starten',
                    'ok garmin video starten',
                    'okay garmin video starten',
                    'garmin starte aufnahme',
                    'garmin start video',
                    'start video garmin',
                    'aufnahme starten garmin',
                    'video recording start',
                    'start recording garmin'
                ];

                this.stopCommands = [
                    'ok garmin video speichern',
                    'okay garmin video speichern',
                    'ok garmin aufnahme speichern',
                    'okay garmin aufnahme speichern',
                    'garmin stoppe video',
                    'garmin stop aufnahme',
                    'stop aufnahme garmin',
                    'video speichern garmin',
                    'stop recording garmin',
                    'save video garmin'
                ];

                this.initElements();
                this.initCamera();
                this.initSpeechRecognition();
                this.bindEvents();
            }

            initElements() {
                this.videoPreview = document.getElementById('videoPreview');
                this.noVideoText = document.getElementById('noVideoText');
                this.recordingIndicator = document.getElementById('recordingIndicator');
                this.speechFeedback = document.getElementById('speechFeedback');
                this.statusText = document.getElementById('statusText');
                this.listeningIndicator = document.getElementById('listeningIndicator');
                this.recognitionQuality = document.getElementById('recognitionQuality');
                this.startListeningBtn = document.getElementById('startListeningBtn');
                this.manualRecordBtn = document.getElementById('manualRecordBtn');
                this.stopRecordBtn = document.getElementById('stopRecordBtn');
                this.testAudioBtn = document.getElementById('testAudioBtn');
                this.audioTest = document.getElementById('audioTest');
                this.audioStatus = document.getElementById('audioStatus');
                this.downloadSection = document.getElementById('downloadSection');
                this.videoList = document.getElementById('videoList');
            }

            async initCamera() {
                console.log('Initialisiere Kamera...');
                try {
                    // Pr√ºfe ob getUserMedia verf√ºgbar ist
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('getUserMedia nicht unterst√ºtzt');
                    }
                    
                    console.log('Fordere Kamera/Mikrofon-Zugriff an...');
                    this.stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            width: { ideal: 1920 }, 
                            height: { ideal: 1080 },
                            facingMode: 'environment'
                        },
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            sampleRate: 44100
                        }
                    });
                    
                    console.log('Stream erhalten:', this.stream);
                    this.videoPreview.srcObject = this.stream;
                    this.videoPreview.style.display = 'block';
                    this.noVideoText.style.display = 'none';
                    this.updateStatus('üé§ Bereit - Spracherkennung aktivieren', 'inactive');
                    
                    // Audio-Tracks pr√ºfen
                    const audioTracks = this.stream.getAudioTracks();
                    const videoTracks = this.stream.getVideoTracks();
                    console.log('Audio Tracks:', audioTracks.length, 'Video Tracks:', videoTracks.length);
                    
                } catch (error) {
                    console.error('Kamera-Fehler:', error);
                    this.noVideoText.textContent = `‚ùå Fehler: ${error.message}`;
                    if (error.name === 'NotAllowedError') {
                        this.updateStatus('Kamera/Mikrofon-Berechtigung verweigert', 'inactive');
                        this.noVideoText.textContent = '‚ùå Berechtigung verweigert - Seite neu laden und "Zulassen" dr√ºcken';
                    } else if (error.name === 'NotFoundError') {
                        this.updateStatus('Keine Kamera gefunden', 'inactive');
                        this.noVideoText.textContent = '‚ùå Keine Kamera gefunden';
                    } else if (error.name === 'NotReadableError') {
                        this.updateStatus('Kamera wird von anderer App verwendet', 'inactive');
                        this.noVideoText.textContent = '‚ùå Kamera blockiert - andere Apps schlie√üen';
                    } else {
                        this.updateStatus('Kamera-Fehler: ' + error.message, 'inactive');
                    }
                }
            }

            initSpeechRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    
                    this.recognition.continuous = true;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'de-DE';
                    this.recognition.maxAlternatives = 3; // Mehr Alternativen f√ºr bessere Erkennung

                    this.recognition.onstart = () => {
                        console.log('Spracherkennung gestartet');
                        this.isListening = true;
                        this.updateUI();
                        this.updateRecognitionQuality();
                    };

                    this.recognition.onresult = (event) => {
                        let interimTranscript = '';
                        let finalTranscript = '';
                        
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                finalTranscript += transcript;
                                this.recognitionAttempts++;
                            } else {
                                interimTranscript += transcript;
                            }
                        }

                        // Live-Feedback anzeigen
                        if (interimTranscript || finalTranscript) {
                            this.showSpeechFeedback(finalTranscript || interimTranscript);
                        }

                        if (finalTranscript) {
                            const success = this.processSpeechResult(finalTranscript.toLowerCase().trim());
                            if (success) {
                                this.recognitionSuccess++;
                            }
                            this.updateRecognitionQuality();
                        }
                    };

                    this.recognition.onerror = (event) => {
                        console.error('Spracherkennungsfehler:', event.error);
                        this.showSpeechFeedback(`Fehler: ${event.error}`, true);
                        
                        setTimeout(() => {
                            if (this.isListening && !this.isRecording) {
                                this.startListening();
                            }
                        }, 2000);
                    };

                    this.recognition.onend = () => {
                        if (this.isListening) {
                            setTimeout(() => this.startListening(), 500);
                        }
                    };
                    
                    this.updateRecognitionQuality();
                } else {
                    console.error('Spracherkennung nicht unterst√ºtzt');
                    this.updateStatus('Spracherkennung nicht verf√ºgbar - Chrome Browser verwenden', 'inactive');
                    this.recognitionQuality.textContent = '‚ùå Browser unterst√ºtzt keine Spracherkennung';
                }
            }

            processSpeechResult(transcript) {
                console.log('Erkannt:', transcript);

                // Tolerantere Erkennung mit Teilstring-Matching
                for (let command of this.startCommands) {
                    if (this.matchesCommand(transcript, command) && !this.isRecording) {
                        this.showSpeechFeedback('‚úÖ START-Befehl erkannt!');
                        setTimeout(() => this.startRecording(), 500);
                        return true;
                    }
                }

                for (let command of this.stopCommands) {
                    if (this.matchesCommand(transcript, command) && this.isRecording) {
                        this.showSpeechFeedback('‚úÖ STOP-Befehl erkannt!');
                        setTimeout(() => this.stopRecording(), 500);
                        return true;
                    }
                }

                return false;
            }

            matchesCommand(transcript, command) {
                // Entferne Sonderzeichen und normalisiere
                const normalizeText = (text) => text.toLowerCase()
                    .replace(/[.,!?]/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();

                const normaliz
